# AltMedia Scan Form

## Docker

The application currently runs just a single, database-less Rails image using our typical three-stage build. To build it, just run:

```sh
docker-compose build --pull
```

Compose stops at the "development" target by default. To build for production, run:

```sh
DOCKER_TARGET=production docker-compose build --pull
```

The app depends on a few "secrets", credentials you'll need to mock in order to run the stack:

- MAIL_PASSWORD: The password for the lib-noreply SPA email account.
- PRIVATE_KEY: An SSH private key used to execute an expect script.
- SECRET_KEY_BASE: A random string generated by `rails secret`.

For testing, you can add mock credentials to the ./secrets directory:

```sh
touch secrets/{MAIL_PASSWORD,PATRON_URL,PRIVATE_KEY,SECRET_KEY_BASE}
chmod 0600 secrets/*
```

(Don't worry: the .gitignore skips files in that directory.)

Once you've scaffolded secrets, you can start the application. Make sure to run the typical Rails startup tasks while you're at it:

```sh
docker-compose up -d rails
docker-compose run --rm rails assets:precompile assets:clean
```

Barring a port collision (which _you'll_ have to fix), the app will be available at http://localhost:3000/. Note that the app relies on CAS authentication, so you'll probably want to access it via an /etc/hosts alias:

```
127.0.0.1 altmedia-dev.lib.berkeley.edu
```

### Testing

To run the application tests:

```sh
# Test the application code
docker-compose run --rm -e RAILS_ENV=test rails test

# Audit Gemfile.lock for vulnerabilities
docker-compose run --rm rails bundle:audit

# Run static analysis to check for code/sql injection, xss, etc.
docker-compose run --rm rails brakeman
```

### Deploying

Jenkins automatically builds and tests every commit. Commits to the master branch are also tagged, pushed to the registry, and deployed to production using the `docker-compose.prod.yml` configuration file. To deploy a new version to production:

- Check [the registry](https://git.lib.berkeley.edu/lap/altmedia/container_registry) for the version of the app images you want to deploy, then update the production configuration (docker-compose.prod.yml) with the relevant tags.
- Commit only those changes with the commit message "Deploying <tag> to production".
- Push your commit, which Jenkins will rollout to production.

Jenkins checks that https://altmedia.lib.berkeley.edu returns a non-4xx/5xx error code after the deploy. If the deploy fails, the job will also fail.
