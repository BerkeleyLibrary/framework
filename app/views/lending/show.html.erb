<% content_for(:page_title, "UC BEARS: #{@lending_item.title}") %>

<%
  # TODO: should this logic really be in the view?

  loan_active = @lending_item_loan&.active?
  show_viewer = loan_active || lending_admin?
  viewer_title = loan_active ? 'View' : 'Preview'
  item_processed = @lending_item.processed?
  directory = @lending_item.directory

  # TODO: Use Rails i18n
  fields = {
    'Title' => @lending_item.title,
    'Author' => @lending_item.author,
    'Record ID' => @lending_item.record_id,
    'Barcode' => @lending_item.barcode,
    'Copies' => @lending_item.copies,
    'Copies available' => @lending_item.copies_available
  }
  if @lending_item_loan
    if @lending_item_loan.persisted?
      fields['Loan status'] = @lending_item_loan.loan_status
      fields['Checked out'] = @lending_item_loan.loan_date # TODO: format all dates
      if @lending_item_loan.active?
        fields['Due'] = @lending_item_loan.due_date # TODO: format all dates
      end
    end
    if @lending_item_loan.complete?
      fields['Returned'] = @lending_item_loan.return_date
    end
  end

  if lending_admin?
    due_dates = @lending_item.due_dates.to_a
    unless due_dates.empty?
      fields['Due dates for current checkouts'] = due_dates
    end

    if @lending_item.processed?
      fields['Processed?'] = 'Yes'
      fields['IIIF directory'] = @lending_item.iiif_dir
    else
      fields['Processed?'] = 'No'
    end
    fields['Directory'] = @lending_item.directory

    fields['Direct link'] = link_to(lending_url(directory: directory))
  end
%>

<% if lending_admin? %>
  <%# TODO: style navigation properly %>
  <nav><%= link_to 'Back', lending_path %></nav>
<% end %>

<section class="record">
  <% if show_viewer %>
    <%= render(partial: 'viewer', locals: {
      manifest_url: manifest_url,
      viewer_title: viewer_title,
      item_processed: item_processed
    }) %>
  <% end %>

  <table>
    <% fields.each do |label, value| %>
      <tr>
        <th><%= label %></th>
        <td>
          <% if value.respond_to?(:each) %>
              <% value.each { |v| %><p><%= v %></p><% } %>
          <% else %>
            <%= value %>
          <% end %>
        </td>
      </tr>
    <% end %>
    <tr>
      <th class="action">
        <% if @lending_item_loan %> <%# TODO: is this the best way to decide whether to show the checkout button? %>
          <% if loan_active %>
            <%= link_to('Return now', lending_return_path(directory: directory), class: 'btn btn-danger') %>
          <% elsif @lending_item.checkout_disabled? %>
            <span class="btn btn-primary disabled">Check out</span>
          <% else %>
            <%= link_to('Check out', lending_check_out_path(directory: directory), class: 'btn btn-primary') %>
          <% end %>
        <% end %>
        <% if lending_admin? %>
          <%= link_to('Edit', lending_edit_path(directory: directory), class: 'btn btn-secondary') %>
        <% end %>
      </th>
    </tr>
  </table>
</section>
